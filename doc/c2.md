# Capítulo 2: Recursos

## 2.1 Arquitetura da Solução

### 2.1.1 Visão Geral

O sistema foi desenvolvido seguindo uma arquitetura de três camadas (3-tier architecture) com separação clara de responsabilidades:

```
┌─────────────────────────────────────────────────┐
│          CAMADA DE APRESENTAÇÃO                 │
│                                                 │
│  React-Admin Backoffice (Port 3001)            │
│  - Interface de gestão                          │
│  - Componentes React                            │
│  - Material-UI                                  │
│  - DataProvider customizado                     │
└─────────────────────────────────────────────────┘
                      │
                      │ HTTP/REST (JSON)
                      ▼
┌─────────────────────────────────────────────────┐
│          CAMADA DE APLICAÇÃO                    │
│                                                 │
│  LoopBack 4 API (Port 3000)                    │
│  - Controllers REST (CRUD)                      │
│  - Repositories (ORM)                           │
│  - Models com decorators                        │
│  - Validações automáticas                       │
│  - OpenAPI Explorer (/explorer)                 │
└─────────────────────────────────────────────────┘
                      │
                      │ Connector MySQL
                      ▼
┌─────────────────────────────────────────────────┐
│          CAMADA DE DADOS                        │
│                                                 │
│  MySQL 8.0 (Port 3310)                         │
│  - 6 tabelas relacionais                        │
│  - Foreign keys                                 │
│  - 155+ registos de teste                       │
└─────────────────────────────────────────────────┘
```

### 2.1.2 Princípios REST Implementados

A API segue rigorosamente os princípios RESTful:

- **Stateless** - Cada pedido contém toda a informação necessária (sem sessões no servidor)
- **Client-Server** - Separação total entre cliente (React-Admin) e servidor (LoopBack)
- **Uniform Interface** - Endpoints padronizados e previsíveis
- **Resource-Based** - Cada recurso identificado por URI único (`/api/owners/{id}`)
- **Representations** - JSON como formato único de troca de dados
- **HTTP Methods** - GET (read), POST (create), PATCH (update), PUT (replace), DELETE (delete)

### 2.1.3 Padrão MVC no LoopBack 4

```
┌──────────┐
│  Model   │ ─────► Owner, Vehicle, ServiceType,
│  (@model)│        ServiceRecord, Mechanic
└────┬─────┘
     │
     ▼
┌──────────────┐
│ Repository   │ ─────► CRUD automático gerado
│ (extends)    │        pelo LoopBack 4
└────┬─────────┘
     │
     ▼
┌──────────────┐
│ Datasource   │ ─────► MySQL Connector
│ (MySQL)      │        (localhost:3310)
└──────────────┘
     ▲
     │
┌────┴─────────┐
│ Controller   │ ─────► REST API Endpoints
│ (@get, @post)│        (/api/owners, etc)
└──────────────┘
```

**Fluxo de um pedido:**

1. Cliente faz `GET /api/owners/1`
2. Controller (`OwnerController`) recebe o pedido
3. Controller chama `OwnerRepository.findById(1)`
4. Repository executa query SQL via datasource MySQL
5. MySQL retorna dados
6. Repository converte para objeto `Owner`
7. Controller serializa para JSON
8. Resposta enviada ao cliente

---

## 2.2 Modelo de Dados

### 2.2.1 Diagrama Entidade-Relacionamento

```
┌─────────────────┐
│     OWNERS      │
│─────────────────│
│ id (PK)         │
│ name            │
│ email (UNIQUE)  │
│ phone           │
└────────┬────────┘
         │ 1
         │
         │ has many
         │
         ▼ n
┌─────────────────┐
│    VEHICLES     │
│─────────────────│
│ id (PK)         │
│ owner_id (FK)   │
│ brand           │
│ model           │
│ license_plate(U)│
│ year            │
└────────┬────────┘
         │ 1
         │
         │ has many
         │
         ▼ n
┌─────────────────────┐          ┌─────────────────┐
│  SERVICE_RECORDS    │          │ SERVICE_TYPES   │
│─────────────────────│          │─────────────────│
│ id (PK)             │    n:1   │ id (PK)         │
│ vehicle_id (FK)     │◄─────────┤ name            │
│ service_type_id(FK) │          │ description     │
│ service_date        │          └─────────────────┘
│ mileage_km          │
│ cost                │
│ notes               │
└─────────────────────┘

┌─────────────────┐
│   MECHANICS     │
│─────────────────│
│ id (PK)         │
│ name            │
│ specialization  │
│ phone           │
│ email (UNIQUE)  │
└─────────────────┘

**Tabela Junction (não exposta via API):**
    ┌──────────────────────────┐
    │ SERVICE_RECORD_MECHANICS │
    │──────────────────────────│
    │ service_record_id (PK1)  │
    │ mechanic_id (PK2)        │
    └──────────────────────────┘
```

**Legenda:**
- PK = Primary Key
- FK = Foreign Key
- U = Unique
- 1:n = One-to-Many

**Nota:** A tabela `service_record_mechanics` existe na base de dados mas não está acessível via API LoopBack.

### 2.2.2 Descrição das Tabelas

#### Tabela: `owners`

Armazena informação dos proprietários de veículos.

| Campo | Tipo         | Constraints       | Descrição                     |
| ----- | ------------ | ----------------- | ----------------------------- |
| id    | INT          | PK, AUTO_INCREMENT| Identificador único           |
| name  | VARCHAR(100) | NOT NULL          | Nome completo do proprietário |
| email | VARCHAR(100) | NOT NULL, UNIQUE  | Email (autenticação futura)   |
| phone | VARCHAR(30)  | NULL              | Telefone de contacto          |

**Índices:** PRIMARY KEY (id), UNIQUE KEY (email)

#### Tabela: `vehicles`

Armazena informação dos veículos associados a proprietários.

| Campo         | Tipo         | Constraints       | Descrição                     |
| ------------- | ------------ | ----------------- | ----------------------------- |
| id            | INT          | PK, AUTO_INCREMENT| Identificador único           |
| owner_id      | INT          | NOT NULL, FK      | Proprietário do veículo       |
| brand         | VARCHAR(50)  | NOT NULL          | Marca (ex: Volkswagen)        |
| model         | VARCHAR(50)  | NOT NULL          | Modelo (ex: Golf)             |
| license_plate | VARCHAR(20)  | NOT NULL, UNIQUE  | Matrícula (ex: AB-12-CD)      |
| year          | INT          | NULL              | Ano de fabrico                |

**Relações:**
- `owner_id` REFERENCES `owners(id)` - Relação 1:N

**Índices:** PRIMARY KEY (id), UNIQUE KEY (license_plate), FOREIGN KEY (owner_id)

#### Tabela: `service_types`

Catálogo de tipos de serviço de manutenção disponíveis.

| Campo       | Tipo          | Constraints       | Descrição                              |
| ----------- | ------------- | ----------------- | -------------------------------------- |
| id          | INT           | PK, AUTO_INCREMENT| Identificador único                    |
| name        | VARCHAR(100)  | NOT NULL          | Nome do serviço (ex: "Mudança de Óleo")|
| description | VARCHAR(255)  | NULL              | Descrição detalhada do serviço         |

**Índices:** PRIMARY KEY (id)

**Exemplos de registos:**
- "Mudança de Óleo" - Substituição do óleo do motor
- "Revisão dos 10.000 km" - Revisão periódica completa
- "Mudança de Pastilhas de Travão" - Substituição das pastilhas

#### Tabela: `service_records`

Histórico de manutenções realizadas nos veículos.

| Campo            | Tipo          | Constraints       | Descrição                       |
| ---------------- | ------------- | ----------------- | ------------------------------- |
| id               | INT           | PK, AUTO_INCREMENT| Identificador único             |
| vehicle_id       | INT           | NOT NULL, FK      | Veículo que recebeu o serviço   |
| service_type_id  | INT           | NOT NULL, FK      | Tipo de serviço realizado       |
| service_date     | DATE          | NOT NULL          | Data da manutenção              |
| mileage_km       | INT           | NOT NULL          | Quilometragem no momento        |
| cost             | DECIMAL(10,2) | NOT NULL          | Custo do serviço em euros       |
| notes            | TEXT          | NULL              | Observações adicionais          |

**Relações:**
- `vehicle_id` REFERENCES `vehicles(id)` - Relação N:1
- `service_type_id` REFERENCES `service_types(id)` - Relação N:1

**Índices:** PRIMARY KEY (id), FOREIGN KEY (vehicle_id), FOREIGN KEY (service_type_id)

#### Tabela: `mechanics`

Cadastro de mecânicos que realizam os serviços.

| Campo          | Tipo          | Constraints       | Descrição                          |
| -------------- | ------------- | ----------------- | ---------------------------------- |
| id             | INT           | PK, AUTO_INCREMENT| Identificador único                |
| name           | VARCHAR(100)  | NOT NULL          | Nome completo do mecânico          |
| specialization | VARCHAR(100)  | NULL              | Especialidade (ex: "Motor Diesel") |
| phone          | VARCHAR(30)   | NULL              | Telefone de contacto               |
| email          | VARCHAR(100)  | UNIQUE            | Email (único, opcional)            |

**Índices:** PRIMARY KEY (id), UNIQUE KEY (email)

#### Tabela: `service_record_mechanics` (Junction Table - não acessível via API)

Tabela de relação entre registos de serviço e mecânicos. Esta tabela existe na base de dados mas não foi exposta através da API LoopBack (não há endpoints para aceder diretamente a esta relação).

| Campo              | Tipo | Constraints    | Descrição                             |
| ------------------ | ---- | -------------- | ------------------------------------- |
| service_record_id  | INT  | PK1, FK        | Registo de serviço                    |
| mechanic_id        | INT  | PK2, FK        | Mecânico que trabalhou no serviço     |

**Relações:**
- `service_record_id` REFERENCES `service_records(id)` ON DELETE CASCADE
- `mechanic_id` REFERENCES `mechanics(id)` ON DELETE CASCADE

**Índices:** PRIMARY KEY (service_record_id, mechanic_id), FOREIGN KEYS

**Nota:** A composite primary key (service_record_id, mechanic_id) garante que não há duplicados. Esta relação pode ser consultada diretamente via SQL, mas não através dos endpoints REST da API.

### 2.2.3 Dados de Teste

A base de dados é inicializada com os seguintes dados:

| Tabela                     | Registos | Descrição                                    |
| -------------------------- | -------- | -------------------------------------------- |
| owners                     | 30       | Proprietários com dados realistas            |
| vehicles                   | 30       | Veículos variados (VW, Opel, Renault, etc)   |
| service_types              | 30       | Tipos de serviço comuns                      |
| mechanics                  | 30       | Mecânicos com especializações                |
| service_records            | 35       | Registos de manutenção com custos            |
| service_record_mechanics   | 45       | Relações na BD (não acessível via API)       |
| **Total**                  | **155+** | Volume suficiente para testes realistas      |

---

## 2.3 Endpoints da API

### 2.3.1 Padrão de URLs

Todos os endpoints seguem o padrão REST:

```
http://localhost:3000/api/{resource}
http://localhost:3000/api/{resource}/{id}
http://localhost:3000/api/{resource}/count
```

### 2.3.2 Owners - `/api/owners`

#### Listar Todos os Proprietários

```http
GET /api/owners
```

**Parâmetros de Query (opcional):**
- `filter` - Filtro JSON (where, limit, offset, order)

**Resposta (200 OK):**
```json
[
  {
    "id": 1,
    "name": "Gonçalo Azevedo",
    "email": "goncalo@example.com",
    "phone": "+351910000001"
  },
  {
    "id": 2,
    "name": "Maria Santos",
    "email": "maria.santos@example.com",
    "phone": "+351910000002"
  }
]
```

#### Obter Proprietário por ID

```http
GET /api/owners/{id}
```

**Resposta (200 OK):**
```json
{
  "id": 1,
  "name": "Gonçalo Azevedo",
  "email": "goncalo@example.com",
  "phone": "+351910000001"
}
```

#### Criar Novo Proprietário

```http
POST /api/owners
Content-Type: application/json

{
  "name": "António Silva",
  "email": "antonio.silva@example.com",
  "phone": "+351912345678"
}
```

**Resposta (200 OK):**
```json
{
  "id": 31,
  "name": "António Silva",
  "email": "antonio.silva@example.com",
  "phone": "+351912345678"
}
```

#### Atualizar Proprietário (Parcial)

```http
PATCH /api/owners/{id}
Content-Type: application/json

{
  "phone": "+351999888777"
}
```

#### Substituir Proprietário (Completo)

```http
PUT /api/owners/{id}
Content-Type: application/json

{
  "name": "António Silva Updated",
  "email": "antonio.new@example.com",
  "phone": "+351999888777"
}
```

#### Eliminar Proprietário

```http
DELETE /api/owners/{id}
```

**Resposta (204 No Content)**

#### Contar Proprietários

```http
GET /api/owners/count
```

**Resposta (200 OK):**
```json
{
  "count": 30
}
```

### 2.3.3 Vehicles - `/api/vehicles`

Segue o mesmo padrão CRUD que Owners, com campos:

```json
{
  "id": 1,
  "ownerId": 1,
  "brand": "Volkswagen",
  "model": "Golf",
  "licensePlate": "AB-12-CD",
  "year": 2018
}
```

**Endpoints:**
- `GET /api/vehicles` - Listar todos
- `GET /api/vehicles/{id}` - Obter por ID
- `GET /api/vehicles/count` - Contar
- `POST /api/vehicles` - Criar
- `PATCH /api/vehicles/{id}` - Atualizar parcial
- `PUT /api/vehicles/{id}` - Substituir
- `DELETE /api/vehicles/{id}` - Eliminar

### 2.3.4 Service Types - `/api/service-types`

```json
{
  "id": 1,
  "name": "Mudança de Óleo",
  "description": "Substituição do óleo do motor e filtro"
}
```

**Endpoints:** GET, GET/{id}, GET/count, POST, PATCH, PUT, DELETE

### 2.3.5 Service Records - `/api/service-records`

```json
{
  "id": 1,
  "vehicleId": 1,
  "serviceTypeId": 1,
  "serviceDate": "2025-01-05",
  "mileageKm": 15000,
  "cost": 45.50,
  "notes": "Serviço realizado sem problemas"
}
```

**Endpoints:** GET, GET/{id}, GET/count, POST, PATCH, PUT, DELETE

### 2.3.6 Mechanics - `/api/mechanics`

```json
{
  "id": 1,
  "name": "Carlos Sousa",
  "specialization": "Motor Diesel",
  "phone": "+351911111111",
  "email": "carlos.sousa@oficina.pt"
}
```

**Endpoints:** GET, GET/{id}, GET/count, POST, PATCH, PUT, DELETE

---

## 2.4 Filtros e Queries Avançadas

### 2.4.1 Sintaxe de Filtros LoopBack

O LoopBack 4 suporta filtros complexos via query parameter `filter`:

```http
GET /api/owners?filter={filtro_json}
```

### 2.4.2 Exemplos de Filtros

#### Filtrar por Campo Específico

```http
GET /api/vehicles?filter={"where":{"brand":"Volkswagen"}}
```

Retorna apenas veículos da marca Volkswagen.

#### Filtrar por Relação (veículos de um owner)

```http
GET /api/vehicles?filter={"where":{"ownerId":1}}
```

Retorna veículos do proprietário com ID 1.

#### Paginação

```http
GET /api/owners?filter={"limit":10,"offset":0}
```

Retorna os primeiros 10 proprietários (página 1).

```http
GET /api/owners?filter={"limit":10,"offset":10}
```

Retorna proprietários 11-20 (página 2).

#### Ordenação

```http
GET /api/owners?filter={"order":["name ASC"]}
```

Ordena por nome ascendente.

```http
GET /api/vehicles?filter={"order":["year DESC"]}
```

Ordena por ano descendente (mais recentes primeiro).

#### Filtros Complexos com Operadores

```http
GET /api/service-records?filter={"where":{"cost":{"gte":100}}}
```

Registos com custo >= 100€.

```http
GET /api/service-records?filter={"where":{"serviceDate":{"between":["2025-01-01","2025-12-31"]}}}
```

Registos de 2025.

#### Filtros Combinados

```http
GET /api/service-records?filter={
  "where":{
    "cost":{"gte":200},
    "vehicleId":1
  },
  "order":["cost DESC"],
  "limit":10
}
```

Registos do veículo 1, com custo >= 200€, ordenados por custo descendente, máximo 10 resultados.

### 2.4.3 Operadores Disponíveis

| Operador | Descrição         | Exemplo                        |
| -------- | ----------------- | ------------------------------ |
| eq       | Igual             | `{"brand":{"eq":"VW"}}`        |
| neq      | Diferente         | `{"brand":{"neq":"VW"}}`       |
| gt       | Maior que         | `{"year":{"gt":2020}}`         |
| gte      | Maior ou igual    | `{"cost":{"gte":100}}`         |
| lt       | Menor que         | `{"year":{"lt":2015}}`         |
| lte      | Menor ou igual    | `{"cost":{"lte":50}}`          |
| between  | Entre valores     | `{"year":{"between":[2015,2020]}}` |
| like     | Pesquisa textual  | `{"name":{"like":"%Silva%"}}`  |

---

## 2.5 Especificação OpenAPI 3.0

### 2.5.1 Geração Automática

A documentação OpenAPI é **gerada automaticamente** pelo LoopBack 4 a partir dos decorators TypeScript:

```typescript
@get('/api/owners', {
  responses: {
    '200': {
      description: 'Array of Owner model instances',
      content: {
        'application/json': {
          schema: {type: 'array', items: getModelSchemaRef(Owner)},
        },
      },
    },
  },
})
async find(@param.filter(Owner) filter?: Filter<Owner>): Promise<Owner[]> {
  return this.ownerRepository.find(filter);
}
```

Este código gera automaticamente:
- Endpoint `GET /api/owners`
- Descrição da resposta
- Schema JSON do modelo Owner
- Parâmetros de query (filter)

### 2.5.2 API Explorer

A documentação interativa está disponível em:

```
http://localhost:3000/explorer
```

**Funcionalidades:**
- Lista todos os endpoints disponíveis
- Permite testar cada endpoint diretamente no browser
- Mostra schemas de request/response
- Exemplos de payloads JSON
- Códigos de resposta HTTP

**Vantagem:** Documentação sempre sincronizada com o código (Code-first).

---

## 2.6 Collection Postman

### 2.6.1 Organização

A collection está organizada em 5 pastas, uma por recurso:

```
Car Maintenance API
│
├── Owners (9 requests)
│   ├── List All Owners
│   ├── Get Owner by ID
│   ├── Count Owners
│   ├── Create Owner
│   ├── Update Owner (PATCH)
│   ├── Replace Owner (PUT)
│   ├── Delete Owner
│   ├── Filter Owners by Name
│   └── Paginate Owners
│
├── Vehicles (9 requests)
├── Service Types (9 requests)
├── Service Records (10 requests)
└── Mechanics (9 requests)
```

**Total:** 46 requests

### 2.6.2 Variáveis de Ambiente

A collection usa a variável:

```
{{baseUrl}} = http://localhost:3000/api
```

Facilita mudança de ambiente (dev, staging, production).

### 2.6.3 Exemplos de Requests

**Criar Owner:**
```http
POST {{baseUrl}}/owners
{
  "name": "Test Owner",
  "email": "test@example.com",
  "phone": "+351999999999"
}
```

**Filtrar Vehicles por Owner:**
```http
GET {{baseUrl}}/vehicles?filter={"where":{"ownerId":1}}
```

**Criar Service Record com custo:**
```http
POST {{baseUrl}}/service-records
{
  "vehicleId": 1,
  "serviceTypeId": 1,
  "serviceDate": "2025-01-06",
  "mileageKm": 20000,
  "cost": 150.00,
  "notes": "Manutenção programada"
}
```

---

**Próximo:** [Capítulo 3 - Produto →](c3.md)

[← Voltar ao Capítulo 1](c1.md)  
[← Voltar ao README principal](../README.md)
