# Capítulo 2: Recursos

## 2.1 Arquitetura da Solução

### 2.1.1 Visão Geral

O sistema foi desenvolvido seguindo uma arquitetura de três camadas (3-tier architecture) com separação clara de responsabilidades:

```
┌─────────────────────────────────────────────────┐
│          CAMADA DE APRESENTAÇÃO                 │
│                                                 │
│  React-Admin Backoffice (Port 3001)            │
│  - Interface de gestão                          │
│  - Componentes React                            │
│  - Material-UI                                  │
└─────────────────────────────────────────────────┘
                      │
                      │ HTTP/REST
                      ▼
┌─────────────────────────────────────────────────┐
│          CAMADA DE APLICAÇÃO                    │
│                                                 │
│  LoopBack 4 API (Port 3000)                    │
│  - Controllers REST                             │
│  - Business Logic                               │
│  - Validações                                   │
│  - OpenAPI Explorer                             │
└─────────────────────────────────────────────────┘
                      │
                      │ ORM
                      ▼
┌─────────────────────────────────────────────────┐
│          CAMADA DE DADOS                        │
│                                                 │
│  MySQL 8.0 (Port 3306)                         │
│  - Tabelas relacionais                          │
│  - Stored data                                  │
└─────────────────────────────────────────────────┘
```

### 2.1.2 Arquitetura REST

A API segue os princípios RESTful:

- **Stateless** - Cada pedido contém toda a informação necessária
- **Client-Server** - Separação clara entre cliente e servidor
- **Uniform Interface** - Endpoints consistentes e previsíveis
- **Resource-Based** - Recursos identificados por URIs
- **Representations** - JSON como formato de troca de dados

### 2.1.3 Padrão MVC no LoopBack 4

```
Model (Entidade) ──────► Repository ──────► Datasource ──────► MySQL
       ▲                      ▲
       │                      │
       └──────────────────────┘
                 │
                 ▼
            Controller
                 │
                 ▼
            REST API
```

---

## 2.2 Modelo de Dados

### 2.2.1 Diagrama Entidade-Relacionamento

```
┌─────────────────┐
│    CUSTOMER     │
│─────────────────│
│ id (PK)         │
│ name            │
│ email           │
│ phone           │
│ address         │
│ created_at      │
│ updated_at      │
└─────────────────┘
        │ 1
        │
        │ has many
        │
        ▼ n
┌─────────────────┐         ┌─────────────────┐
│    VEHICLE      │         │   WORKSHOP      │
│─────────────────│         │─────────────────│
│ id (PK)         │         │ id (PK)         │
│ customer_id(FK) │         │ name            │
│ brand           │         │ email           │
│ model           │         │ phone           │
│ year            │         │ address         │
│ license_plate   │         │ city            │
│ vin             │         │ postal_code     │
│ color           │         │ created_at      │
│ created_at      │         │ updated_at      │
│ updated_at      │         └─────────────────┘
└─────────────────┘                 │ 1
        │ 1                          │
        │                            │ has many
        │ has many                   │
        │                            ▼ n
        ▼ n                  ┌─────────────────┐
┌─────────────────┐          │  APPOINTMENT    │
│  MAINTENANCE    │          │─────────────────│
│─────────────────│          │ id (PK)         │
│ id (PK)         │          │ vehicle_id (FK) │
│ vehicle_id (FK) │          │ workshop_id(FK) │
│ service_date    │          │ date            │
│ description     │          │ time            │
│ cost            │          │ status          │
│ mileage         │          │ notes           │
│ notes           │          │ created_at      │
│ created_at      │          │ updated_at      │
│ updated_at      │          └─────────────────┘
└─────────────────┘                 │
                                    │ m
                                    │
                        ┌───────────┴───────────┐
                        │                       │
                        │   many-to-many       │
                        │                       │
                        ▼ n                     │
              ┌──────────────────────┐          │
              │APPOINTMENT_SERVICE   │          │
              │──────────────────────│          │
              │ appointment_id (FK)  │          │
              │ service_id (FK)      │          │
              │ price                │          │
              └──────────────────────┘          │
                        │ n                     │
                        └───────────┬───────────┘
                                    │
                                    ▼ 1
                            ┌─────────────────┐
                            │    SERVICE      │
                            │─────────────────│
                            │ id (PK)         │
                            │ name            │
                            │ description     │
                            │ price           │
                            │ duration        │
                            │ category        │
                            │ created_at      │
                            │ updated_at      │
                            └─────────────────┘
```

### 2.2.2 Descrição das Entidades

#### **Customer (Cliente)**

Representa os clientes do sistema de manutenção.

| Campo      | Tipo         | Descrição           | Restrições         |
| ---------- | ------------ | ------------------- | ------------------ |
| id         | INTEGER      | Identificador único | PK, Auto-increment |
| name       | VARCHAR(100) | Nome completo       | NOT NULL           |
| email      | VARCHAR(100) | Email               | UNIQUE, NOT NULL   |
| phone      | VARCHAR(20)  | Telefone            | NOT NULL           |
| address    | VARCHAR(200) | Morada              | NULL               |
| created_at | TIMESTAMP    | Data de criação     | DEFAULT NOW()      |
| updated_at | TIMESTAMP    | Data de atualização | DEFAULT NOW()      |

#### **Vehicle (Veículo)**

Representa os veículos dos clientes.

| Campo         | Tipo        | Descrição           | Restrições         |
| ------------- | ----------- | ------------------- | ------------------ |
| id            | INTEGER     | Identificador único | PK, Auto-increment |
| customer_id   | INTEGER     | Proprietário        | FK → Customer.id   |
| brand         | VARCHAR(50) | Marca               | NOT NULL           |
| model         | VARCHAR(50) | Modelo              | NOT NULL           |
| year          | INTEGER     | Ano                 | NOT NULL           |
| license_plate | VARCHAR(20) | Matrícula           | UNIQUE, NOT NULL   |
| vin           | VARCHAR(17) | Número de chassis   | UNIQUE             |
| color         | VARCHAR(30) | Cor                 | NULL               |
| created_at    | TIMESTAMP   | Data de criação     | DEFAULT NOW()      |
| updated_at    | TIMESTAMP   | Data de atualização | DEFAULT NOW()      |

#### **Workshop (Oficina)**

Representa as oficinas parceiras.

| Campo       | Tipo         | Descrição           | Restrições         |
| ----------- | ------------ | ------------------- | ------------------ |
| id          | INTEGER      | Identificador único | PK, Auto-increment |
| name        | VARCHAR(100) | Nome da oficina     | NOT NULL           |
| email       | VARCHAR(100) | Email               | UNIQUE             |
| phone       | VARCHAR(20)  | Telefone            | NOT NULL           |
| address     | VARCHAR(200) | Morada              | NOT NULL           |
| city        | VARCHAR(50)  | Cidade              | NOT NULL           |
| postal_code | VARCHAR(10)  | Código postal       | NOT NULL           |
| created_at  | TIMESTAMP    | Data de criação     | DEFAULT NOW()      |
| updated_at  | TIMESTAMP    | Data de atualização | DEFAULT NOW()      |

#### **Service (Serviço)**

Catálogo de serviços de manutenção oferecidos.

| Campo       | Tipo          | Descrição           | Restrições                               |
| ----------- | ------------- | ------------------- | ---------------------------------------- |
| id          | INTEGER       | Identificador único | PK, Auto-increment                       |
| name        | VARCHAR(100)  | Nome do serviço     | NOT NULL                                 |
| description | TEXT          | Descrição detalhada | NULL                                     |
| price       | DECIMAL(10,2) | Preço base          | NOT NULL                                 |
| duration    | INTEGER       | Duração (minutos)   | NOT NULL                                 |
| category    | ENUM          | Categoria           | 'preventive', 'corrective', 'inspection' |
| created_at  | TIMESTAMP     | Data de criação     | DEFAULT NOW()                            |
| updated_at  | TIMESTAMP     | Data de atualização | DEFAULT NOW()                            |

#### **Appointment (Agendamento)**

Agendamentos de serviços de manutenção.

| Campo       | Tipo      | Descrição           | Restrições                                       |
| ----------- | --------- | ------------------- | ------------------------------------------------ |
| id          | INTEGER   | Identificador único | PK, Auto-increment                               |
| vehicle_id  | INTEGER   | Veículo             | FK → Vehicle.id                                  |
| workshop_id | INTEGER   | Oficina             | FK → Workshop.id                                 |
| date        | DATE      | Data do agendamento | NOT NULL                                         |
| time        | TIME      | Hora do agendamento | NOT NULL                                         |
| status      | ENUM      | Estado              | 'pending', 'confirmed', 'completed', 'cancelled' |
| notes       | TEXT      | Observações         | NULL                                             |
| created_at  | TIMESTAMP | Data de criação     | DEFAULT NOW()                                    |
| updated_at  | TIMESTAMP | Data de atualização | DEFAULT NOW()                                    |

#### **Maintenance (Manutenção)**

Histórico de manutenções realizadas.

| Campo        | Tipo          | Descrição           | Restrições         |
| ------------ | ------------- | ------------------- | ------------------ |
| id           | INTEGER       | Identificador único | PK, Auto-increment |
| vehicle_id   | INTEGER       | Veículo             | FK → Vehicle.id    |
| service_date | DATE          | Data da manutenção  | NOT NULL           |
| description  | TEXT          | Descrição           | NOT NULL           |
| cost         | DECIMAL(10,2) | Custo total         | NOT NULL           |
| mileage      | INTEGER       | Quilometragem       | NULL               |
| notes        | TEXT          | Observações         | NULL               |
| created_at   | TIMESTAMP     | Data de criação     | DEFAULT NOW()      |
| updated_at   | TIMESTAMP     | Data de atualização | DEFAULT NOW()      |

#### **AppointmentService (Tabela de Junção)**

Relação muitos-para-muitos entre Appointments e Services.

| Campo          | Tipo          | Descrição      | Restrições          |
| -------------- | ------------- | -------------- | ------------------- |
| appointment_id | INTEGER       | Agendamento    | FK → Appointment.id |
| service_id     | INTEGER       | Serviço        | FK → Service.id     |
| price          | DECIMAL(10,2) | Preço acordado | NOT NULL            |

**PK Composta:** (appointment_id, service_id)

### 2.2.3 Relações

#### Relação 1:n (Um para Muitos)

1. **Customer → Vehicle**

   - Um cliente pode ter múltiplos veículos
   - Um veículo pertence a apenas um cliente

2. **Vehicle → Maintenance**

   - Um veículo pode ter múltiplas manutenções
   - Uma manutenção pertence a apenas um veículo

3. **Workshop → Appointment**

   - Uma oficina pode ter múltiplos agendamentos
   - Um agendamento é realizado em apenas uma oficina

4. **Vehicle → Appointment**
   - Um veículo pode ter múltiplos agendamentos
   - Um agendamento é para apenas um veículo

#### Relação m:n (Muitos para Muitos)

**Appointment ↔ Service**

- Um agendamento pode incluir múltiplos serviços
- Um serviço pode estar em múltiplos agendamentos
- Implementado através da tabela de junção `AppointmentService`

---

## 2.3 Endpoints da API

### 2.3.1 Base URL

```
http://localhost:3000/api
```

### 2.3.2 Recursos Disponíveis

#### **Customers** (`/customers`)

| Método | Endpoint                   | Descrição                | Parâmetros              |
| ------ | -------------------------- | ------------------------ | ----------------------- |
| GET    | `/customers`               | Listar todos os clientes | filter, offset, limit   |
| GET    | `/customers/{id}`          | Obter cliente por ID     | -                       |
| GET    | `/customers/{id}/vehicles` | Veículos do cliente      | -                       |
| POST   | `/customers`               | Criar novo cliente       | Body: Customer          |
| PUT    | `/customers/{id}`          | Atualizar cliente        | Body: Customer          |
| PATCH  | `/customers/{id}`          | Atualização parcial      | Body: Partial<Customer> |
| DELETE | `/customers/{id}`          | Eliminar cliente         | -                       |

**Exemplo de Request:**

```http
POST /api/customers
Content-Type: application/json

{
  "name": "João Silva",
  "email": "joao.silva@example.com",
  "phone": "+351 912345678",
  "address": "Rua Principal, 123, 4480-123 Vila do Conde"
}
```

**Exemplo de Response:**

```json
{
  "id": 1,
  "name": "João Silva",
  "email": "joao.silva@example.com",
  "phone": "+351 912345678",
  "address": "Rua Principal, 123, 4480-123 Vila do Conde",
  "created_at": "2026-01-06T10:30:00.000Z",
  "updated_at": "2026-01-06T10:30:00.000Z"
}
```

#### **Vehicles** (`/vehicles`)

| Método | Endpoint                      | Descrição                | Parâmetros             |
| ------ | ----------------------------- | ------------------------ | ---------------------- |
| GET    | `/vehicles`                   | Listar todos os veículos | filter, offset, limit  |
| GET    | `/vehicles/{id}`              | Obter veículo por ID     | -                      |
| GET    | `/vehicles/{id}/maintenances` | Manutenções do veículo   | -                      |
| GET    | `/vehicles/{id}/appointments` | Agendamentos do veículo  | -                      |
| POST   | `/vehicles`                   | Criar novo veículo       | Body: Vehicle          |
| PUT    | `/vehicles/{id}`              | Atualizar veículo        | Body: Vehicle          |
| PATCH  | `/vehicles/{id}`              | Atualização parcial      | Body: Partial<Vehicle> |
| DELETE | `/vehicles/{id}`              | Eliminar veículo         | -                      |

**Exemplo com Filtro:**

```http
GET /api/vehicles?filter={"where":{"brand":"Toyota"},"limit":10}
```

#### **Workshops** (`/workshops`)

| Método | Endpoint                       | Descrição                | Parâmetros              |
| ------ | ------------------------------ | ------------------------ | ----------------------- |
| GET    | `/workshops`                   | Listar todas as oficinas | filter, offset, limit   |
| GET    | `/workshops/{id}`              | Obter oficina por ID     | -                       |
| GET    | `/workshops/{id}/appointments` | Agendamentos da oficina  | -                       |
| POST   | `/workshops`                   | Criar nova oficina       | Body: Workshop          |
| PUT    | `/workshops/{id}`              | Atualizar oficina        | Body: Workshop          |
| PATCH  | `/workshops/{id}`              | Atualização parcial      | Body: Partial<Workshop> |
| DELETE | `/workshops/{id}`              | Eliminar oficina         | -                       |

#### **Services** (`/services`)

| Método | Endpoint         | Descrição                | Parâmetros             |
| ------ | ---------------- | ------------------------ | ---------------------- |
| GET    | `/services`      | Listar todos os serviços | filter, offset, limit  |
| GET    | `/services/{id}` | Obter serviço por ID     | -                      |
| POST   | `/services`      | Criar novo serviço       | Body: Service          |
| PUT    | `/services/{id}` | Atualizar serviço        | Body: Service          |
| PATCH  | `/services/{id}` | Atualização parcial      | Body: Partial<Service> |
| DELETE | `/services/{id}` | Eliminar serviço         | -                      |

**Exemplo de Categorias:**

```http
GET /api/services?filter={"where":{"category":"preventive"}}
```

#### **Appointments** (`/appointments`)

| Método | Endpoint                                  | Descrição                | Parâmetros                 |
| ------ | ----------------------------------------- | ------------------------ | -------------------------- |
| GET    | `/appointments`                           | Listar agendamentos      | filter, offset, limit      |
| GET    | `/appointments/{id}`                      | Obter agendamento por ID | -                          |
| GET    | `/appointments/{id}/services`             | Serviços do agendamento  | -                          |
| POST   | `/appointments`                           | Criar agendamento        | Body: Appointment          |
| POST   | `/appointments/{id}/services`             | Adicionar serviço        | Body: {serviceId, price}   |
| PUT    | `/appointments/{id}`                      | Atualizar agendamento    | Body: Appointment          |
| PATCH  | `/appointments/{id}`                      | Atualização parcial      | Body: Partial<Appointment> |
| DELETE | `/appointments/{id}`                      | Eliminar agendamento     | -                          |
| DELETE | `/appointments/{id}/services/{serviceId}` | Remover serviço          | -                          |

#### **Maintenances** (`/maintenances`)

| Método | Endpoint             | Descrição               | Parâmetros                 |
| ------ | -------------------- | ----------------------- | -------------------------- |
| GET    | `/maintenances`      | Listar manutenções      | filter, offset, limit      |
| GET    | `/maintenances/{id}` | Obter manutenção por ID | -                          |
| POST   | `/maintenances`      | Criar manutenção        | Body: Maintenance          |
| PUT    | `/maintenances/{id}` | Atualizar manutenção    | Body: Maintenance          |
| PATCH  | `/maintenances/{id}` | Atualização parcial     | Body: Partial<Maintenance> |
| DELETE | `/maintenances/{id}` | Eliminar manutenção     | -                          |

### 2.3.3 Filtros e Queries

O LoopBack 4 suporta filtros avançados através do parâmetro `filter`:

```javascript
// Filtrar por campo
GET /api/vehicles?filter={"where":{"brand":"Toyota"}}

// Limitar resultados
GET /api/customers?filter={"limit":10,"skip":0}

// Ordenar
GET /api/services?filter={"order":"price DESC"}

// Incluir relações
GET /api/vehicles?filter={"include":["customer","maintenances"]}

// Filtros complexos
GET /api/appointments?filter={
  "where":{
    "and":[
      {"date":{"gte":"2026-01-01"}},
      {"status":"pending"}
    ]
  }
}
```

### 2.3.4 Códigos de Estado HTTP

| Código                    | Descrição         | Quando Usar                   |
| ------------------------- | ----------------- | ----------------------------- |
| 200 OK                    | Sucesso           | GET, PUT, PATCH bem sucedidos |
| 201 Created               | Criado            | POST bem sucedido             |
| 204 No Content            | Sem conteúdo      | DELETE bem sucedido           |
| 400 Bad Request           | Pedido inválido   | Dados inválidos               |
| 404 Not Found             | Não encontrado    | Recurso não existe            |
| 422 Unprocessable Entity  | Erro de validação | Dados não cumprem regras      |
| 500 Internal Server Error | Erro do servidor  | Erro não previsto             |

---

## 2.4 Documentação OpenAPI 3.0

### 2.4.1 Acesso à Documentação

A documentação OpenAPI está disponível em:

- **API Explorer:** http://localhost:3000/explorer
- **Especificação YAML:** http://localhost:3000/openapi.json

### 2.4.2 Estrutura da Especificação

```yaml
openapi: 3.0.0
info:
  title: Car Maintenance API
  version: 1.0.0
  description: API REST para gestão de manutenção de automóveis
  contact:
    name: Grupo 33
    email: inf25dw1g33@ismai.pt
  license:
    name: MIT

servers:
  - url: http://localhost:3000
    description: Servidor de desenvolvimento

paths:
  /customers:
    get:
      summary: Listar clientes
      tags:
        - Customer
      parameters:
        - name: filter
          in: query
          schema:
            type: object
      responses:
        '200':
          description: Lista de clientes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Customer'
    post:
      summary: Criar cliente
      tags:
        - Customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewCustomer'
      responses:
        '201':
          description: Cliente criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'

components:
  schemas:
    Customer:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        address:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
```

### 2.4.3 Schemas Principais

A especificação inclui schemas detalhados para todos os modelos:

- Customer
- Vehicle
- Workshop
- Service
- Appointment
- Maintenance
- AppointmentService

Cada schema inclui:

- Tipos de dados
- Validações
- Exemplos
- Descrições
- Required fields

---

## 2.5 Collection Postman

### 2.5.1 Organização da Collection

A collection está organizada por recursos:

```
Car Maintenance API
├── Customers
│   ├── List Customers
│   ├── Get Customer by ID
│   ├── Create Customer
│   ├── Update Customer
│   ├── Delete Customer
│   └── Get Customer Vehicles
├── Vehicles
│   ├── List Vehicles
│   ├── Get Vehicle by ID
│   ├── Create Vehicle
│   ├── Update Vehicle
│   ├── Delete Vehicle
│   └── Get Vehicle Maintenances
├── Workshops
│   └── ... (similar structure)
├── Services
│   └── ... (similar structure)
├── Appointments
│   └── ... (similar structure)
└── Maintenances
    └── ... (similar structure)
```

### 2.5.2 Variáveis de Ambiente

```json
{
  "base_url": "http://localhost:3000/api",
  "customer_id": "",
  "vehicle_id": "",
  "workshop_id": "",
  "service_id": "",
  "appointment_id": "",
  "maintenance_id": ""
}
```

### 2.5.3 Testes Incluídos

Cada request inclui testes básicos:

```javascript
// Verificar status code
pm.test('Status code is 200', function () {
  pm.response.to.have.status(200);
});

// Verificar Content-Type
pm.test('Content-Type is JSON', function () {
  pm.response.to.have.header('Content-Type', /json/);
});

// Salvar ID para próximos requests
if (pm.response.code === 201) {
  pm.environment.set('customer_id', pm.response.json().id);
}
```

---

**Próximo:** [Capítulo 3 - Produto →](c3.md)

[← Capítulo 1: Apresentação](c1.md) | [Voltar ao README](../README.md)
